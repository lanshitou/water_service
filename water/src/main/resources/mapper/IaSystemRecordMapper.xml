<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zzwl.ias.mapper.IaSystemRecordMapper">
    <resultMap id="BaseResultMap" type="com.zzwl.ias.domain.IaSystemRecord">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="type" jdbcType="INTEGER" property="type"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="alias" jdbcType="VARCHAR" property="alias"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="is_delete" jdbcType="BIT" property="isDelete"/>
        <result column="delete_time" jdbcType="TIMESTAMP" property="deleteTime"/>
        <result column="max_irr_num" jdbcType="INTEGER" property="maxIrrNum"/>
        <result column="mode" jdbcType="INTEGER" property="mode"/>
        <result column="sort_order" jdbcType="INTEGER" property="sortOrder"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        id, type, name, alias, create_time, is_delete, delete_time, max_irr_num, mode, sort_order
    </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        from iasystem
        where id = #{id,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from iasystem
        where id = #{id,jdbcType=INTEGER}
    </delete>
    <insert id="insert" keyProperty="id" useGeneratedKeys="true"
            parameterType="com.zzwl.ias.domain.IaSystemRecord">
        insert into iasystem (type,
                              name,
                              alias,
                              max_irr_num,
                              mode,
                              sort_order,
                              province_id,
                              city_id,
                              district_id,
                              town_id,
                              village_id,
                              address)
        values (#{type},
                #{name},
                #{alias},
                #{maxIrrNum},
                #{mode},
                #{sortOrder},
                #{provinceId},
                #{cityId},
                #{districtId},
                #{townId},
                #{villageId},
                #{address})
    </insert>
    <insert id="insertSelective" parameterType="com.zzwl.ias.domain.IaSystemRecord">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into iasystem
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="type != null">
                type,
            </if>
            <if test="name != null">
                name,
            </if>
            <if test="alias != null">
                alias,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="isDelete != null">
                is_delete,
            </if>
            <if test="deleteTime != null">
                delete_time,
            </if>
            <if test="maxIrrNum != null">
                max_irr_num,
            </if>
            <if test="mode != null">
                mode,
            </if>
            <if test="sortOrder != null">
                sort_order,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="type != null">
                #{type,jdbcType=INTEGER},
            </if>
            <if test="name != null">
                #{name,jdbcType=VARCHAR},
            </if>
            <if test="alias != null">
                #{alias,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="isDelete != null">
                #{isDelete,jdbcType=BIT},
            </if>
            <if test="deleteTime != null">
                #{deleteTime,jdbcType=TIMESTAMP},
            </if>
            <if test="maxIrrNum != null">
                #{maxIrrNum,jdbcType=INTEGER},
            </if>
            <if test="mode != null">
                #{mode,jdbcType=INTEGER},
            </if>
            <if test="sortOrder != null">
                #{sortOrder,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.zzwl.ias.domain.IaSystemRecord">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update iasystem
        <set>
            <if test="type != null">
                type = #{type,jdbcType=INTEGER},
            </if>
            <if test="name != null">
                name = #{name,jdbcType=VARCHAR},
            </if>
            <if test="alias != null">
                alias = #{alias,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="isDelete != null">
                is_delete = #{isDelete,jdbcType=BIT},
            </if>
            <if test="deleteTime != null">
                delete_time = #{deleteTime,jdbcType=TIMESTAMP},
            </if>
            <if test="maxIrrNum != null">
                max_irr_num = #{maxIrrNum,jdbcType=INTEGER},
            </if>
            <if test="mode != null">
                mode = #{mode,jdbcType=INTEGER},
            </if>
            <if test="sortOrder != null">
                sort_order = #{sortOrder,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.zzwl.ias.domain.IaSystemRecord">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update iasystem
        set type = #{type,jdbcType=INTEGER},
        name = #{name,jdbcType=VARCHAR},
        alias = #{alias,jdbcType=VARCHAR},
        delete_time = #{deleteTime,jdbcType=TIMESTAMP},
        max_irr_num = #{maxIrrNum,jdbcType=INTEGER},
        mode = #{mode,jdbcType=INTEGER},
        sort_order = #{sortOrder,jdbcType=INTEGER},
        province_id = #{provinceId},
        city_id = #{cityId},
        district_id = #{districtId},
        town_id = #{townId},
        village_id = #{villageId},
        address = #{address}
        where id = #{id,jdbcType=INTEGER}
    </update>

    <select id="selectAllIaSystemRecord" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from iasystem
    </select>

    <select id="selectAllWeatherStation" resultMap="BaseResultMap">
        select id, name, alias
        from iasystem
        where type = 2
    </select>

    <select id="selectIaSystemById" resultMap="BaseResultMap">
        select id,
               type,
               name,
               alias,
               create_time,
               max_irr_num,
               mode,
               sort_order
        from iasystem
        where id = #{id}
    </select>

    <select id="selectIaSystemRecordByKeyword" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from iasystem
        <where>type =1
            <if test="keyword != null">
                and (`name` like #{keyword})
            </if>
            <if test="keyword != null">
                or (`alias` like #{keyword})
            </if>
        </where>
        order by sort_order,id DESC
    </select>

    <!--<select id="selectIaSystemByUser" resultMap="BaseResultMap">-->
    <!--select-->
    <!--<include refid="Base_Column_List" />-->
    <!--from iasystem-->
    <!--</select>-->
    <resultMap id="UserIasystemAndFarmlandMap" type="com.zzwl.ias.vo.IasystemAndFarmlandVo">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="rid" jdbcType="INTEGER" property="roleId"/>
        <result column="role_name" jdbcType="VARCHAR" property="roleName"/>
    </resultMap>
    <select id="selectUserSystem" resultMap="UserIasystemAndFarmlandMap">
        SELECT i.id, i.name, rp.id rid, rp.role_name
        FROM user_ias ui
                 LEFT JOIN iasystem i ON ui.ias_id = i.id
                 LEFT JOIN role_permission rp ON ui.role_id = rp.id
        WHERE ui.user_id = #{userId}
          AND i.is_delete = 0
    </select>
    <resultMap id="IasystemAndFarmlandMap" type="com.zzwl.ias.vo.IasystemAndFarmlandVo">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <id column="iid" jdbcType="INTEGER" property="iid"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
    </resultMap>
    <select id="selectIasystemAndFarmland" resultMap="IasystemAndFarmlandMap">
        SELECT ff.id id, ff.name, a.*
        FROM farmland ff
                 LEFT JOIN (SELECT f.id iid
                            FROM farmland f
                                     LEFT JOIN user_farmland uf ON f.id = uf.fm_id
                            WHERE uf.user_id = #{userId}
                              AND uf.ias_id = #{iasId}) a ON ff.id = a.iid
        WHERE ff.iasystem_id = #{iasId}
    </select>
    <select id="selectAllFarmlandInIaSystem" resultMap="IasystemAndFarmlandMap">
        SELECT f.id, f.name
        FROM farmland f
        WHERE f.iasystem_id = #{iasId}
    </select>
    <insert id="insertIaSystemAndFarmland" parameterType="com.zzwl.ias.dto.iasystem.AddIaSystemAndFarmlandDTO">
        INSERT INTO user_farmland (user_id, ias_id,fm_id, role_id)
        VALUES
        <foreach collection="fids" item="fid" separator=",">
            (#{userId}, #{iasId},#{fid}, #{roleId})
        </foreach>
    </insert>
    <select id="countIaSystemAndFarmland" resultType="java.lang.Integer">
        SELECT COUNT(*) countt
        FROM user_farmland uf
        WHERE uf.user_id = #{userId}
          AND uf.fm_id = #{fid}
          AND uf.ias_id = #{iasId}
    </select>
    <update id="updateIaSystemRole">
        UPDATE user_ias ui
        SET ui.role_id = #{roleId}
        WHERE ui.user_id = #{userId}
          AND ui.ias_id = #{iasId}
    </update>
    <delete id="deleteUserAndIaSystem">
        DELETE
        FROM user_farmland
        WHERE user_id = #{userId}
          AND ias_id = #{iasId}
    </delete>
    <resultMap id="IaSystemvListMap" type="com.zzwl.ias.vo.IaSystemListVo">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="alias" jdbcType="VARCHAR" property="alias"/>
        <result column="address" jdbcType="VARCHAR" property="address"/>
        <result column="max_irr_num" jdbcType="INTEGER" property="maxIrrNum"/>
        <result column="mode" jdbcType="INTEGER" property="mode"/>
        <result column="type" jdbcType="INTEGER" property="type"/>
        <result column="create_time" jdbcType="VARCHAR" property="time"/>
    </resultMap>
    <select id="selectIaSystemList" resultMap="IaSystemvListMap">
        SELECT
        i.id,
        i.name,
        i.alias,
        i.max_irr_num,
        i.mode,
        i.type,
        DATE_FORMAT(i.create_time,'%Y-%m-%d %H:%i:%S') create_time,
        CONCAT(
        IFNULL(cr.name, ''),
        IFNULL(crr.name, ''),
        IFNULL(crrr.name, ''),
        IFNULL(crrrr.name, ''),
        IFNULL(crrrrr.name, ''),
        IFNULL(i.address, '')
        ) address
        FROM iasystem i
        LEFT JOIN common_region cr ON cr.id = i.province_id
        LEFT JOIN common_region crr ON crr.id = i.city_id
        LEFT JOIN common_region crrr ON crrr.id = i.district_id
        LEFT JOIN common_region crrrr ON crrrr.id = i.town_id
        LEFT JOIN common_region crrrrr ON crrrrr.id = i.village_id
        <where>
            i.is_delete = 0
            <if test="like != ''">
                and (i.id = #{like} or i.name like CONCAT('%',#{like},'%') or i.alias like CONCAT('%',#{like},'%'))
            </if>
            <if test="regionId != null">
                and ( i.province_id = #{regionId} or
                i.city_id = #{regionId} or
                i.district_id = #{regionId} or
                i.town_id = #{regionId} or
                i.village_id = #{regionId})
            </if>
        </where>
        ORDER BY i.create_time DESC
    </select>
    <resultMap id="IaSystemDetailMap" type="com.zzwl.ias.vo.iasystem.IaSystemDetailVo">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="alias" jdbcType="VARCHAR" property="alias"/>
        <result column="max_irr_num" jdbcType="INTEGER" property="maxIrrNum"/>
        <result column="mode" jdbcType="INTEGER" property="mode"/>
        <result column="sort_order" jdbcType="INTEGER" property="sortOrder"/>
        <result column="province_id" jdbcType="INTEGER" property="provinceId"/>
        <result column="city_id" jdbcType="INTEGER" property="cityId"/>
        <result column="district_id" jdbcType="INTEGER" property="districtId"/>
        <result column="town_id" jdbcType="INTEGER" property="townId"/>
        <result column="village_id" jdbcType="INTEGER" property="villageId"/>
        <result column="address" jdbcType="VARCHAR" property="address"/>
        <result column="type" jdbcType="INTEGER" property="type"/>
    </resultMap>
    <select id="selectIaSystemDetail" resultMap="IaSystemDetailMap">
        SELECT i.id,
               i.type,
               i.name,
               i.alias,
               i.max_irr_num,
               i.mode,
               i.sort_order,
               i.province_id,
               i.city_id,
               i.district_id,
               i.town_id,
               i.village_id,
               i.address
        FROM iasystem i
        WHERE i.id = #{iasId}
    </select>
</mapper>